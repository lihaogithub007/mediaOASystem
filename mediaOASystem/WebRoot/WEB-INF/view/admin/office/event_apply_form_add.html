<!DOCTYPE html>
<!--[if IE 8]> <html class="ie8"> <![endif]-->
<!--[if IE 9]> <html class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html> <!--<![endif]-->
<head>
<meta charset="utf-8" />
<title>新媒体智能管理系统</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<meta content="" name="description" />
<meta content="" name="author" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="renderer" content="webkit|ie-comp|ie-stand" />
<link href="$!webPath/resources/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/bootstrap/css/bootstrap-fileupload.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
<link href="$!webPath/resources/css/style.css" rel="stylesheet" />
<link href="$!webPath/resources/css/style_responsive.css" rel="stylesheet" />
<link href="$!webPath/resources/css/style_default.css" rel="stylesheet" id="style_color" />
<link href="$!webPath/resources/assets/chosen-bootstrap/chosen/v1.7/chosen.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/fancybox/source/jquery.fancybox.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/toastr/toastr.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/uniform/css/uniform.default.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/css/custom/custom.css" rel="stylesheet" type="text/css" />
<style type="text/css">
#myModal{
	width:1000px;
	margin-left:-500px;
}
</style>
</head>
<body class="fixed-top">
	<div id="header" class="navbar navbar-inverse navbar-fixed-top">
		$!httpInclude.include("/common/_header.htm") 
	</div>
	<div id="container" class="row-fluid">
		<div id="sidebar" class="nav-collapse collapse">
			$!httpInclude.include("/common/_sidebar.htm?op=event_apply_form") 
		</div>
		<div id="main-content">
			<div class="container-fluid">
				<div class="row-fluid">
					<div class="span12">
						<h3 class="page-title">事项申请表添加</h3>
						<ul class="breadcrumb">
							<li><a href="$!webPath/index.htm"><i class="icon-home"></i></a><span class="divider">&nbsp;</span></li>
					        <li><a href="javascript:void(0);">行政办公</a><span class="divider">&nbsp;</span></li>
							<li><a href="$!webPath/admin/office/event_apply_form_add.htm?currentPage=$!currentPage">事项申请表添加</a><span class="divider-last">&nbsp;</span></li>
						</ul>
					</div>
				</div>
				<div class="row-fluid">
					<form name="theForm" id="theForm" action="$!webPath/admin/office/event_apply_form_add_save.htm" method="post" class="form-horizontal">
		            	<div class="span12">
							<div class="widget">
		                    	<div class="widget-title">
		                        	<h4><i class="icon-reorder"></i>事项申请表添加</h4>
		                     	</div>
                     			<div class="widget-body form">
									<div class="control-group">
		                        		<label class="control-label"><font class="red_font">*</font>项目名称</label>
	                                    <div class="controls">
	                                    	 <input type="text" name="project_name" id="project_name" placeholder="项目名称" class="span6 popovers" maxlength="50"
	                                        	data-trigger="hover" data-content="输入项目名称，最多50字符"/>
	                                    </div>
		                           	</div>
									<div class="control-group">
		                        		<label class="control-label"><font class="red_font">*</font>申请日期</label>
	                                    <div class="controls">
	                                    	 <input type="text" name="apply_date" placeholder="申请日期" class="span6 popovers" 
	                                    	 	data-trigger="hover" data-content="请点击选择申请日期" readonly="readonly"  onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})"/>
	                                        <span class="help-inline"></span>
	                                    </div>
		                           	</div>
		                           	<div class="control-group">
		                        		<label class="control-label">编号</label>
	                                    <div class="controls">
	                                    	 <input type="text" name="project_code" id="project_code" placeholder="编号" class="span6 popovers" maxlength="50"
	                                        	data-trigger="hover" data-content="输入编号，示例[2017]年[推-002-1]号，[2017]年[购-003-1]号，最多50字符"/>
	                                    </div>
		                           	</div>
		                           	<div class="control-group">
		                        		<label class="control-label">预算金额</label>
	                                    <div class="controls">
	                                    	 <input type="text" name="budget_amount" id="budget_amount" placeholder="预算金额" class="span6 popovers" maxlength="13"
	                                        	data-trigger="hover" data-content="输入预算金额，最多2位小数"/>
	                                    </div>
		                           	</div>
		                           	<div class="control-group">
		                            	<label class="control-label"><font class="red_font">*</font>申请科组</label>
		                              	<div class="controls">
			                            	<select data-placeholder="选择申请科组" class="span6 chosen" tabindex="-1" multiple="multiple" name="apply_department_ids" id="apply_department_ids">
												#foreach($obj in $!departments)
						                        <option value="$!obj.id">$!obj.department_name</option>
						                        #end
											</select>
		                              	</div>
		                           	</div>
		                           	<div class="control-group">
		                            	<label class="control-label"><font class="red_font">*</font>事项申请人</label>
		                              	<div class="controls">
											<a href="javascript:void(0);" class="btn btn-primary" id="btn_apply_user">选择申请人</a>
											<input type="hidden" name="apply_user_ids" id="apply_user_ids"/>
											<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel1" aria-hidden="true"></div>
		                              	</div>
		                           	</div>
		                           	<div class="control-group">
		                            	<label class="control-label"></label>
		                              	<div class="controls">
											<textarea class="span6" name="apply_user_names" id="apply_user_names" rows="3" readonly="readonly"></textarea>
		                              	</div>
		                           	</div>
		                           	<div class="control-group">
		                            	<label class="control-label">申请事项</label>
		                              	<div class="controls">
		                                	<textarea class="span6" name="apply_event" id="apply_event" rows="2"></textarea>
		                              	</div>
		                           	</div>
		                           	<div class="control-group">
		                            	<label class="control-label"><font class="red_font">*</font>负责人</label>
		                              	<div class="controls">
			                            	<select data-placeholder="选择负责人" class="span6 chosen" tabindex="-1" name="leader_user_id" id="leader_user_id">
												<option value="">选择负责人</option>
												#foreach($obj in $!users)
						                        <option value="$!obj.id">$!obj.true_name（$!obj.department.department_name）</option>
						                        #end
											</select>
		                              	</div>
		                           	</div>
		                           	<div class="control-group">
		                        		<label class="control-label">经办人</label>
	                                    <div class="controls">
	                                        <input type="text" name="agent_user_name" placeholder="经办人" class="span6 popovers" maxlength="50"
	                                        	data-trigger="hover" data-content="输入经办人，最多50字符"/>
	                                        <span class="help-inline"></span>
	                                    </div>
		                           	</div>
		                           	<div class="control-group">
		                            	<label class="control-label"><font class="red_font">*</font>费用支出公司</label>
		                              	<div class="controls">
			                            	<select data-placeholder="费用支出公司" class="span6 chosen" tabindex="-1" name="cost_company_id" id="cost_company_id">
												<option value="">请选择费用支出公司</option>
												#foreach($key in ${cost_company_map.keySet()})
								                <option value="$key">${cost_company_map.get($key)}</option>
								                #end
											</select>
		                              	</div>
		                           	</div>
		                        	<div class="control-group">
		                        		<label class="control-label">费用所属合同</label>
	                                    <div class="controls">
	                                        <input type="text" name="cost_contract" placeholder="费用所属合同" class="span6 popovers" maxlength="50"
	                                        	data-trigger="hover" data-content="输入费用所属合同，最多50字符"/>
	                                        <span class="help-inline"></span>
	                                    </div>
		                           	</div>
		                           	<div class="control-group">
		                        		<label class="control-label">所属合同金额</label>
	                                    <div class="controls">
	                                    	<input type="text" name="cost_contract_amount" placeholder="所属合同金额" class="span6 popovers" maxlength="13"
	                                        	data-trigger="hover" data-content="输入所属合同金额，最多2位小数"/>
	                                        <span class="help-inline"></span>
	                                    </div>
		                           	</div>
		                           	$!httpInclude.include("/common/_include_upload_file.htm")  
                                    <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
									<div class="clearfix space15"></div>
                           			<div class="form-actions">
                           				<input type="button" id="btn_submit" class="btn btn-primary" value="保存"/>
                           				<a href="$!webPath/admin/office/event_apply_form_list.htm?currentPage=$!currentPage" class="btn">返回</a>
                           			</div>
	                     		</div>
	                  		</div>
		                </div>
		                <input type="hidden" name="currentPage" id="currentPage" value="$!currentPage"/>
				  	</form>
				</div>
			</div>
		</div>
	</div>
	<div id="footer">
		$!httpInclude.include("/common/_footer.htm")	
	</div>
	<script src="$!webPath/resources/js/jquery-1.8.3.min.js"></script>
    <script src="$!webPath/resources/assets/fileupload/js/vendor/jquery.ui.widget.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/tmpl.min.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/load-image.min.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/canvas-to-blob.min.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.blueimp-gallery.min.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.iframe-transport.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.fileupload.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.fileupload-process.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.fileupload-image.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.fileupload-validate.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/jquery.fileupload-ui.js"></script>
	<script src="$!webPath/resources/assets/fileupload/js/main.js"></script>
	<!--[if (gte IE 8)&(lt IE 10)]>
	<script src="$!webPath/resources/assets/fileupload/js/cors/jquery.xdr-transport.js"></script>
	<![endif]-->
    <script src="$!webPath/resources/assets/bootstrap/js/bootstrap.min.js"></script>   
    <script src="$!webPath/resources/js/jquery.blockui.js"></script>
    <!-- ie8 fixes -->
    <!--[if lt IE 9]>
    <script src="$!webPath/resources/js/excanvas.js"></script>
    <script src="$!webPath/resources/js/respond.js"></script>
    <![endif]-->   
    <script src="$!webPath/resources/assets/chosen-bootstrap/chosen/v1.7/chosen.jquery.js" type="text/javascript"></script>
    <script src="$!webPath/resources/assets/fancybox/source/jquery.fancybox.pack.js"></script>  
    <script src="$!webPath/resources/assets/uniform/jquery.uniform.min.js" type="text/javascript"></script>
    <script src="$!webPath/resources/js/jquery.validate.min.js" type="text/javascript" ></script>
	<script src="$!webPath/resources/js/jquery.validate.ext.js" type="text/javascript" ></script>
	<script src="$!webPath/resources/js/jquery.form.min.js" type="text/javascript" ></script>
    <script src="$!webPath/resources/assets/My97DatePicker/WdatePicker.js" type="text/javascript" ></script>
    <script src="$!webPath/resources/assets/toastr/toastr.js" type="text/javascript" ></script>
    <script src="$!webPath/resources/assets/data-tables/jquery.dataTables.js"></script>
    <script src="$!webPath/resources/assets/data-tables/DT_bootstrap.js"></script>
    <script src="$!webPath/resources/js/scripts.js"></script>
    <script src="$!webPath/resources/js/custom/common.js"></script>
    <script>
	jQuery(document).ready(function() {   
		App.init();
		initToastr();
		jqueryValidate();
		bindEvent();
		bindDialogEvent();
	});
	function jqueryValidate(){
		jQuery("#theForm").validate({
			errorPlacement : function(error, element) { 
				$(error).appendTo($(element).parent()); 
			},
			rules:{
				project_name:{required:true},
				apply_date:{required:true},
				apply_department_ids:{required:true},
				leader_user_id:{required:true},
				cost_company_id:{required:true},
				budget_amount:{isDouble:[]},
				cost_contract_amount:{isDouble:[]},
	       	},
			messages:{
				project_name:{required:"项目名称不能为空"},
				apply_date:{required:"申请日期不能为空"},
				apply_department_ids:{required:"申请科组不能为空"},
				leader_user_id:{required:"负责人不能为空"},
				cost_company_id:{required:"费用支出公司不能为空"},
			}
		}); 
		var validator = $("#theForm").data("validator");
        validator.settings.ignore = ":hidden:not(select)";
	}
	function bindEvent(){
		jQuery("#btn_submit").bind("click", function(){
			if (jQuery("#theForm").valid()) {
				if(isEmpty(jQuery("#apply_user_ids").val())){
					alert("事项申请人不能为空");
					return false;
				}
				jQuery("#loadingBar").show();
				setAttachmentsIds();
				ajaxFormSubmit('theForm','defaultAjaxSaveCallBack');
			}
		});
	}
	function bindDialogEvent(){
		jQuery("#btn_apply_user").bind("click", function(){
			jQuery.ajax({
				type:"post",
			    url:"$!webPath/admin/user/user_multiple_select_dialog.htm",
			    data:{"user_ids":jQuery("#apply_user_ids").val()},
				success:
					function(data){
		        		jQuery("#myModal").html(data);
		        		bindDataTable();
		        		jQuery("#myModal").width(1000);
		        		jQuery("#myModal").modal("show");
	              	}
	  		});
		});
	}
	function unBindEvent(){
		jQuery("#btn_submit").unbind();
	}
	
	function bindDataTable(){
		$("#dataTable").dataTable({
            "sDom": "<'row-fluid'<'span6'l><'span6'f>r>t<'row-fluid'<'span6'i><'span6'p>>",
            "sPaginationType": "bootstrap",
            "bPaginate": false, 
            "bAutoWidth": false,
            "oLanguage": {
            	"sSearch": "搜索:",
    			"sLengthMenu": "每页显示 _MENU_ 条记录",
    			"sZeroRecords": "没有用户记录",
    			"sInfo": "显示第_START_-_END_条记录",
    			"sInfoEmpty": "显示0条记录",
    			"sInfoFiltered":"(共_MAX_条记录)",
            },
            "aoColumnDefs": [{
                "bSortable": false,
                "aTargets": [0]
            }]
        });
		jQuery("#dataTable .group-checkable").unbind();
        jQuery("#dataTable .group-checkable").change(function () {
            var set = jQuery(this).attr("data-set");
            var checked = jQuery(this).is(":checked");
            jQuery(set).each(function () {
                if (checked) {
                    $(this).attr("checked", true);
                } else {
                    $(this).attr("checked", false);
                }
            });
            jQuery.uniform.update(set);
        });
        jQuery("#btn_confirm").unbind();
        jQuery("#btn_confirm").bind("click", function(){
        	jQuery("#dataTable_filter").children("label").children("input[type='text']").val("");
        	var user_ck_checked = jQuery("input[name='user_ck']:checked");
        	var size = user_ck_checked.length;
        	if(0==size){
        		jQuery("#apply_user_ids").val("");
        		jQuery("#apply_user_names").val("");
        		jQuery("#btn_cancel").click();
        		return false;
        	}
        	var arr = [];
        	for(var i = 0; i < size; i++){
        		var apply_user_id = jQuery(user_ck_checked[i]).val();
        		if(contains(arr, apply_user_id)){
        			continue;
        		}else{
        			arr.push(apply_user_id);
        		}
        	}
        	jQuery("#apply_user_ids").val(arr.join(","));
        	console.log("apply_user_ids==>"+jQuery("#apply_user_ids").val());
        	jQuery("#btn_cancel").click();
        	ajaxGetUserNames(jQuery("#apply_user_ids").val());
        	return false;
        });
	}
	function ajaxGetUserNames(apply_user_ids){
		jQuery("#loadingBar").show();
		jQuery.ajax({
			type:"post",
		    url:"$!webPath/admin/user/ajax_get_user_names.htm",
		    data:{"user_ids":apply_user_ids},
		    dataType : "json", 
			success:function(data){
				jQuery("#loadingBar").hide();
				if(data && data.result){
					jQuery("#apply_user_names").val(data.data);
				}else{
					toastr.error(data.msg,"操作失败");
				}
	        },
			error : function() {
				jQuery("#loadingBar").hide();
				alert("信息提交错误");
			}
		});
	}
	</script>
	<script type="text/javascript">
    var uploader = $("#theForm");
    $(function () {
        "use strict";
        uploader.fileupload({
            "url": "$!webPath/admin/office/eafUpload.htm",
            "method": "post",
            "autoUpload": false,
            "limitMultiFileUploads": 2, 
            "limitConcurrentUploads": 1, 
            "maxFileSize": 50 * 1024 * 1024,
            "maxNumberOfFiles": 10,
            messages: {
                maxNumberOfFiles: '文件个数不能超过10个',
                maxFileSize: '文件过大, 最大不能超过50M',
            },
            "previewMaxWidth": 50,
            "previewMaxHeight": 50,
        });
    });
    function setAttachmentsIds(){
    	var attach_nodes = jQuery("input[name='attachments_id']");
    	var size = attach_nodes.length;
    	if(0==size){
    		jQuery("#attachments_ids").val("");
    	}else{
    		var arr = [];
    		for(var i=0; i<size; i++){
    			var attachments_id = jQuery(attach_nodes[i]).val();
    			if(isEmpty(attachments_id) || contains(arr, attachments_id)){
    				continue;
    			}else{
    				arr.push(attachments_id);
    			}
    		}
        	jQuery("#attachments_ids").val(arr.join(","));
    	}
    }
	</script>
</body>
</html>