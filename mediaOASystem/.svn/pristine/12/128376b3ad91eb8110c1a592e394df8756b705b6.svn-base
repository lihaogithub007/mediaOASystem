<link href="$!webPath/resources/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/bootstrap/css/bootstrap-fileupload.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
<link href="$!webPath/resources/css/style.css" rel="stylesheet" />
<link href="$!webPath/resources/css/style_responsive.css" rel="stylesheet" />
<link href="$!webPath/resources/css/style_default.css" rel="stylesheet" id="style_color" />
<link href="$!webPath/resources/assets/chosen-bootstrap/chosen/v1.7/chosen.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/fancybox/source/jquery.fancybox.css" rel="stylesheet" />
<link href="$!webPath/resources/assets/toastr/toastr.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/uniform/css/uniform.default.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/bootstrap-toggle-buttons/static/stylesheets/bootstrap-toggle-buttons.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/bootstrap-datepicker/css/datepicker.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/bootstrap-timepicker/compiled/timepicker.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/assets/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet" type="text/css" />
<link href="$!webPath/resources/css/custom/custom.css" rel="stylesheet" type="text/css" />
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel1">加班记录</h3>
</div>
<div class="modal-body">
    <div class="row-fluid">
		<form name="theForm" id="theForm" action="$!webPath/admin/work_attendance/overtime_record_edit_save.htm" method="post" class="form-horizontal">
        	<div class="span12">
        		<div class="widget">
	            	<div class="widget-title">
	                	<h4><i class="icon-reorder"></i>加班记录</h4>
	                </div>
           			<div class="widget-body form">
	                	<div class="control-group">
	                		<label class="control-label">姓名</label>
	                        <div class="controls"><span>$!user.true_name</span></div>
	                   	</div>
	                	<div class="control-group">
	                		<label class="control-label">日期</label>
	                        <div class="controls"><span>$!date</span></div>
	                   	</div>
                       	<div class="control-group">
                       		<label class="control-label"><font class="red_font">*</font>加班类型</label>
                          	<div class="controls">
                             	<select data-placeholder="请选择加班类型" class="input-xlarge chosen" tabindex="-1" name="overtime_status" id="overtime_status">
									<option value="">请选择加班类型</option>
									#foreach($key in ${overtime_status_map.keySet()})
					                <option value="$key">${overtime_status_map.get($key)}</option>
					                #end
								</select>
                          	</div>
                       	</div>
                       	<div class="control-group">
                       		<label class="control-label">正常上班时间</label>
                          	<div class="controls"><span id="normal_work_hours"></span></select>
                          	</div>
                       	</div>
		                <div class="control-group">
		                	<label class="control-label"><font class="red_font">*</font>开始时间</label>
	                        <div class="controls">
	                        	<div class="input-append bootstrap-timepicker-component">
	                                <input type="text" name="begin_time" id="begin_time" value="#if(''==$!CommUtil.parseDateTimeHourMinute($!obj.work_begin_time)) 09:00 #else $!CommUtil.parseDateTimeHourMinute($!obj.work_begin_time) #end" 
	                                	class="input-xlarge" placeholder="开始时间" />
	                                <span class="add-on"><i class="icon-time"></i></span>
	                            </div>
	                        </div>
		                </div>
		                <div class="control-group">
		                	<label class="control-label"><font class="red_font">*</font>结束时间</label>
	                        <div class="controls">
	                        	<div class="input-append bootstrap-timepicker-component">
	                                <input type="text" name="end_time" id="end_time" value="#if(''==$!CommUtil.parseDateTimeHourMinute($!obj.work_end_time)) 17:30 #else $!CommUtil.parseDateTimeHourMinute($!obj.work_end_time) #end" class="input-xlarge" placeholder="结束时间" />
	                                <span class="add-on"><i class="icon-time"></i></span>
	                            </div>
	                        </div>	
		                </div>
		                <div class="control-group">
		                	<label class="control-label">加班时长</label>
	                        <div class="controls"><span id="work_hours">#if(""=="$!obj.work_hours") 0:00 #else $!obj.work_hours #end</span></div>
		                </div>
	            	</div>
	            </div>
			</div>
			<input type="hidden" name="id" value="$!obj.id"/>
			<input type="hidden" name="user_id" id="user_id" value="$!user.id"/>
			<input type="hidden" name="overtime_date" id="overtime_date" value="$!date"/>
		</form>
    </div>
</div>
<div class="modal-footer">
    <input type="button" id="btn_confirm" class="btn btn-primary" value="确定"/>
    <input type="button" id="btn_cancel" class="btn" data-dismiss="modal" aria-hidden="true" value="关闭"/>
</div>
<script src="$!webPath/resources/js/jquery-1.8.3.min.js"></script>
<script src="$!webPath/resources/assets/bootstrap/js/bootstrap.min.js"></script>   
<script src="$!webPath/resources/js/jquery.blockui.js"></script>
<!-- ie8 fixes -->
<!--[if lt IE 9]>
<script src="$!webPath/resources/js/excanvas.js"></script>
<script src="$!webPath/resources/js/respond.js"></script>
<![endif]-->   
<script src="$!webPath/resources/assets/chosen-bootstrap/chosen/v1.7/chosen.jquery.js" type="text/javascript"></script>
<script src="$!webPath/resources/assets/uniform/jquery.uniform.min.js" type="text/javascript"></script>
<script src="$!webPath/resources/assets/bootstrap-toggle-buttons/static/js/jquery.toggle.buttons.js" type="text/javascript" ></script>
<script src="$!webPath/resources/js/jquery.validate.min.js" type="text/javascript" ></script>
<script src="$!webPath/resources/js/jquery.validate.ext.js" type="text/javascript" ></script>
<script src="$!webPath/resources/js/jquery.form.min.js" type="text/javascript" ></script>
<script src="$!webPath/resources/assets/My97DatePicker/WdatePicker.js" type="text/javascript" ></script>
<script src="$!webPath/resources/assets/bootstrap-datepicker/js/bootstrap-datepicker.js" type="text/javascript" ></script> 
<script src="$!webPath/resources/assets/bootstrap-daterangepicker/date.js" type="text/javascript" ></script>
<script src="$!webPath/resources/assets/bootstrap-daterangepicker/daterangepicker.js" type="text/javascript" ></script> 
<script src="$!webPath/resources/assets/bootstrap-timepicker/js/bootstrap-timepicker.js" type="text/javascript" ></script>
<script src="$!webPath/resources/assets/toastr/toastr.js" type="text/javascript" ></script>
<script src="$!webPath/resources/js/scripts.js"></script>
<script src="$!webPath/resources/js/custom/common.js"></script>
<script>
jQuery(document).ready(function() {   
	jQuery("#overtime_status").val("$!{obj.overtime_status}");
	jQuery("#overtime_status").trigger("chosen:updated");
	$("#overtime_status").chosen({
        allow_single_deselect: true,
        search_contains:true,
       	no_results_text: "没有找到"
    });
	initToastr();
	jqueryValidate();
	init();
	overtime_status_change();
	bindEvent();
});
function jqueryValidate(){
	jQuery("#theForm").validate({
		errorPlacement : function(error, element) { 
			$(error).appendTo($(element).parent()); 
		},
		rules:{
			overtime_status:{required:true},
			begin_time:{required:true},
			end_time:{required:true},
       	},
		messages:{
			overtime_status:{required:"请选择加班类型"},
			begin_time:{required:"请选择开始时间"},
			end_time:{required:"请选择结束时间"},
		}
	}); 
	var validator = $("#theForm").data("validator");
    validator.settings.ignore = ":hidden:not(select)";
}
function init(){
	var overtime_status = "$!{obj.overtime_status}";
	if("1"==overtime_status){
		jQuery("#normal_work_hours").html("8小时30分钟");
	}else if("2"==overtime_status){
		jQuery("#normal_work_hours").html("0小时");
	}else{
		jQuery("#normal_work_hours").html("");
	}
	jQuery("input[name='begin_time'],input[name='end_time']").timepicker({
		defaultTime:'',
        minuteStep: 1,
        showSeconds: false,
        showMeridian: false,
        showInputs: false,
        disableFocus: true
    }).on('hide.timepicker', function(e) {
    	changeWorkHours();
	});
}

function changeWorkHours(){
	var overtime_status = jQuery("#overtime_status").val();
	if(!("1"==overtime_status || "2"==overtime_status)){
		jQuery("#work_hours").html("0:00");
		return false;
	}
	var begin_time = jQuery("#begin_time").val();
	var end_time = jQuery("#end_time").val();
	if(isEmpty(begin_time) || isEmpty(end_time)){
		jQuery("#work_hours").html("0:00");
		return false;
	}
	begin_time = begin_time.trim();
	end_time = end_time.trim();
	var begin_hour = parseInt(begin_time.split(":")[0]);
	var begin_minute = parseInt(begin_time.split(":")[1]);
    var end_hour = parseInt(end_time.split(":")[0]);
    var end_minute = parseInt(end_time.split(":")[1]);
    if (begin_hour > end_hour || (begin_hour == end_hour && begin_minute > end_minute)) {
        alert("加班开始时间在加班结束时间之后");
        return false;
    }
    var base_minutes = 0;
    if ("1"==overtime_status) {
        base_minutes = 8 * 60 + 30;
    }
    var result_minutes = (end_hour * 60 + end_minute) - (begin_hour * 60 + begin_minute) - base_minutes;
    var work_hours = "";
    if (result_minutes < 0) {
        work_hours = "-";
    }
    var hour = Math.floor(Math.abs(result_minutes)/60);
    var minute = Math.abs(result_minutes) - hour*60;
    work_hours = work_hours + hour + ":";
    if(minute<10){
    	work_hours = work_hours + "0" + minute;
    } else {
        work_hours = work_hours + minute;
    } 
    jQuery("#work_hours").html(work_hours);
}

function overtime_status_change(){
	jQuery("#overtime_status").change(function(){
		var thisVal = jQuery(this).val();
		if("1"==thisVal){
			jQuery("#normal_work_hours").html("8小时30分钟");
			
		}else if("2"==thisVal){
			jQuery("#normal_work_hours").html("0小时");
		}else{
			jQuery("#normal_work_hours").html("");
		}
		changeWorkHours();
	});
}
function bindEvent(){
	jQuery("#btn_confirm").bind("click", function(){
		if (jQuery("#theForm").valid()) {
			jQuery("#loadingBar").show();
			ajaxFormSubmit('theForm','ajaxSaveCallBack');
		}
	});
}

function ajaxSaveCallBack(data){
	if(data && data.result){
		if("function"==typeof(unBindEvent)){
			unBindEvent();
		}
		jQuery("#loadingBar").hide();
		jQuery("#btn_cancel").click();
		console.log("td.pointer_td[attr_id='"+data.data.user_id+"'][attr_date='"+data.data.overtime_datestr+"']");
		jQuery("td.pointer_td[attr_id='"+data.data.user_id+"'][attr_date='"+data.data.overtime_datestr+"']").html(data.data.work_hours);
		jQuery("td.pointer_td[attr_id='"+data.data.user_id+"'][attr_date='"+data.data.overtime_datestr+"']").siblings("td.totalTime").html(data.data.totalTime);
		toastr.success(data.msg);
	}else{
		jQuery("#loadingBar").hide();
		if("timeout"==data.msg){
			toastr.error("登录超时,请重新登录","操作失败");
			var count=1;
	        var interval = window.setInterval(function(){
	        	count--;
	        	if(count==0) {
	        		window.location.href = data.data;
	            	clearInterval(interval);	    	
	            }
	       },1000);
		}else{
			toastr.error(data.msg,"操作失败");	
		}
	}
}

function unBindEvent(){
	jQuery("#btn_confirm").unbind();
}
</script>
