package com.yuyu.soft.timer;

import java.io.IOException;
import java.util.List;

import javax.annotation.Resource;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.stereotype.Component;

import com.yuyu.soft.entity.AttendanceRecord;
import com.yuyu.soft.entity.TimerLogs;
import com.yuyu.soft.entity.User;
import com.yuyu.soft.service.IAttendanceRecordService;
import com.yuyu.soft.service.ITimerLogsService;
import com.yuyu.soft.service.IUserService;
import com.yuyu.soft.util.CommUtil;

/**
 * 考勤记录初始化定时任务
 * 每月1日零点  
 * @Filename: PerMonthInitAttendanceRecordTimer.java
 * @Version: 1.0
 * @Author: 李明
 * @Email: limn_xmj@163.com
 *
 */
@Component("perMonthInitAttendanceRecordTimer_task")
public class PerMonthInitAttendanceRecordTimer {

    protected static final Log       log = LogFactory
                                             .getLog(PerMonthInitAttendanceRecordTimer.class);
    @Resource
    private ITimerLogsService        timerLogsService;
    @Resource
    private IUserService             userService;
    @Resource
    private IAttendanceRecordService attendanceRecordService;

    public void execute() throws IOException {

        String attendance_record_month = CommUtil.getFirstDayOfMonth();
        log.info("\n【考勤记录初始化】考勤日期：" + attendance_record_month);
        TimerLogs timerLog = timerLogsService.saveLogs("考勤记录初始化定时任务【月】");
        initAttendanceRecord(attendance_record_month);
        timerLogsService.updateLogs(timerLog);
    }

    //初始化月考勤记录
    private void initAttendanceRecord(String attendance_record_month) {
        List<AttendanceRecord> arList = attendanceRecordService.queryAttendanceRecord(null,
            attendance_record_month);

        List<User> userList = userService.queryAllUserByUserStatus("1,2,3");//非离职员工
        if (userList != null && userList.size() > 0) {
            for (User user : userList) {
                try {
                    boolean exist = false;
                    if (arList != null && arList.size() > 0) {
                        for (AttendanceRecord ar : arList) {
                            if (ar.getUser() != null && ar.getUser().getId() != null
                                && ar.getUser().getId() == user.getId()) {
                                exist = true;
                                break;
                            }
                        }
                    }
                    if (!exist) {
                        attendanceRecordService.add_save(user, attendance_record_month);
                    }

                } catch (Exception e) {
                    log.error("【考勤记录初始化】error==>用户：" + user.getTrue_name() + ", 时间："
                              + attendance_record_month);
                }
            }
        }

    }
}
